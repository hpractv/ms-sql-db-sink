name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  versioning:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.gitversion.outputs.NEXT_VERSION_NO_PREFIX }}
      tag_name: ${{ steps.gitversion.outputs.NEXT_VERSION }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate Next Version
        id: gitversion
        uses: im-open/git-version-lite@v3.2.0
        with:
          tag-prefix: v
          default-release-type: patch

      - name: Update Version and Create Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          NEXT_VERSION="${{ steps.gitversion.outputs.NEXT_VERSION_NO_PREFIX }}"
          TAG_NAME="${{ steps.gitversion.outputs.NEXT_VERSION }}"

          echo "Next Version: $NEXT_VERSION"
          echo "Tag Name: $TAG_NAME"

          # Update csproj
          sed -i "s|<Version>.*</Version>|<Version>$NEXT_VERSION</Version>|" src/MSSQLDBSink/MSSQLDBSink.csproj

          git add src/MSSQLDBSink/MSSQLDBSink.csproj
          git commit -m "Bump version to $NEXT_VERSION [skip ci]"
          git tag "$TAG_NAME"

          # Push changes
          git push origin main
          git push origin "$TAG_NAME"

  build-and-release:
    needs: versioning
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - rid: win-x64
            archive_name: MSSQLDBSink-win-x64
          - rid: win-arm64
            archive_name: MSSQLDBSink-win-arm64
          - rid: linux-x64
            archive_name: MSSQLDBSink-linux-x64
          - rid: osx-arm64
            archive_name: MSSQLDBSink-osx-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.versioning.outputs.tag_name }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish
        run: dotnet publish src/MSSQLDBSink/MSSQLDBSink.csproj -c Release -r ${{ matrix.rid }} --self-contained true -p:PublishSingleFile=true -o release/${{ matrix.archive_name }}

      - name: Archive artifacts
        run: |
          cd release
          if [[ "${{ matrix.rid }}" == *"win"* ]]; then
            zip -r ../${{ matrix.archive_name }}.zip ${{ matrix.archive_name }}
          else
            tar -czvf ../${{ matrix.archive_name }}.tar.gz ${{ matrix.archive_name }}
          fi

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.archive_name }}
          path: |
            *.zip
            *.tar.gz

  create-release:
    needs: [versioning, build-and-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.versioning.outputs.tag_name }}

      - name: Create Release
        id: create-release
        uses: im-open/create-release@v3.2.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          tag-name: ${{ needs.versioning.outputs.tag_name }}
          release-name: Release ${{ needs.versioning.outputs.tag_name }}
          commitish: ${{ needs.versioning.outputs.tag_name }}
          generate-release-notes: true

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Upload win-x64 artifact
        uses: im-open/upload-release-asset@v1.1.4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          upload-url: ${{ steps.create-release.outputs.asset-upload-url }}
          asset-path: artifacts/MSSQLDBSink-win-x64.zip
          asset-name: MSSQLDBSink-win-x64.zip
          asset-content-type: application/zip

      - name: Upload win-arm64 artifact
        uses: im-open/upload-release-asset@v1.1.4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          upload-url: ${{ steps.create-release.outputs.asset-upload-url }}
          asset-path: artifacts/MSSQLDBSink-win-arm64.zip
          asset-name: MSSQLDBSink-win-arm64.zip
          asset-content-type: application/zip

      - name: Upload linux-x64 artifact
        uses: im-open/upload-release-asset@v1.1.4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          upload-url: ${{ steps.create-release.outputs.asset-upload-url }}
          asset-path: artifacts/MSSQLDBSink-linux-x64.tar.gz
          asset-name: MSSQLDBSink-linux-x64.tar.gz
          asset-content-type: application/gzip

      - name: Upload osx-arm64 artifact
        uses: im-open/upload-release-asset@v1.1.4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          upload-url: ${{ steps.create-release.outputs.asset-upload-url }}
          asset-path: artifacts/MSSQLDBSink-osx-arm64.tar.gz
          asset-name: MSSQLDBSink-osx-arm64.tar.gz
          asset-content-type: application/gzip
