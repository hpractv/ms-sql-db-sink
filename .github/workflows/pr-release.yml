name: PR Pre-release

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - rid: win-x64
            archive_name: MSSQLDBSink-win-x64
          - rid: win-arm64
            archive_name: MSSQLDBSink-win-arm64
          - rid: linux-x64
            archive_name: MSSQLDBSink-linux-x64
          - rid: osx-arm64
            archive_name: MSSQLDBSink-osx-arm64

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Set Version
      run: |
        echo "VERSION=0.0.0-pr-${{ github.event.number }}-${{ github.run_number }}" >> $GITHUB_ENV

    - name: Publish
      run: dotnet publish src/MSSQLDBSink/MSSQLDBSink.csproj -c Release -r ${{ matrix.rid }} --self-contained true -p:PublishSingleFile=true -p:Version=${{ env.VERSION }} -o release/${{ matrix.archive_name }}

    - name: Archive artifacts
      run: |
        cd release
        if [[ "${{ matrix.rid }}" == *"win"* ]]; then
          zip -r ../${{ matrix.archive_name }}.zip ${{ matrix.archive_name }}
        else
          tar -czvf ../${{ matrix.archive_name }}.tar.gz ${{ matrix.archive_name }}
        fi

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.archive_name }}
        path: |
          *.zip
          *.tar.gz

  create-pr-release:
    needs: build-and-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: pr-${{ github.event.number }}
          name: PR #${{ github.event.number }} Check-in Build
          body: |
            Automatic pre-release for PR #${{ github.event.number }}.
            Commit: ${{ github.sha }}
            Run: ${{ github.run_number }}
          prerelease: true
          files: |
            artifacts/*.zip
            artifacts/*.tar.gz
